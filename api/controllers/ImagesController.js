const fs = require('fs')
var multer = require('multer');
const { Image } = require('../models');
var base64ToImage = require('base64-to-image');

const storage = multer.diskStorage({
    destination: (req, file, callback) => {
        callback(null, './api/uploads');
    },
    filename: (req, file, callback) => {
        var fileExtension = file.originalname.split(".")[1];
        var myDate = new Date().toJSON().replace(new RegExp(':', 'g'), '.');
        callback(null, myDate + '.' + fileExtension);
    }
});

var upload = multer({ storage: storage }).single('file');

module.exports = {
    async get(req, res) {
        const defaultImage = 'data:image/jpeg;base64,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';

        try {
            const imageId = (req.query.imageId)
                ? req.query.imageId : null;
            const image = await Image.findByPk(imageId)
            res.status(200).send(image);
        } catch (err) {
            res.status(500).send(defaultImage)
        }
    },
    async post(req, res) {
        try {
            upload(req, res, async function (err) {
                if (err) {
                    return res.send(err);
                }
                // var img = fs.readFileSync(req.file.path);
                // var fileExtension = req.file.originalname.split(".")[1].toLowerCase();
                // var encode_image = `data:image/${fileExtension};base64,` + img.toString('base64');
                // Define a JSONobject for the image attributes for saving to database

                // const image = await Image.create({
                //     base64: encode_image
                // })
                const host = req.host;
                const filePath = req.protocol + "://" + host + '/score/' + req.file.path;
                res.status(200).send({result:filePath, status:200});

            });
        } catch (err) {
            res.status(500).send({
                error: 'error while insert data products APIs'
            })
        }

    }
}